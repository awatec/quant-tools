name: Claude Code Automation

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  process-claude-code:
    # タイトルに [CLAUDE-CODE] か、ラベル claude-code が付いたら起動
    if: contains(github.event.issue.title, '[CLAUDE-CODE]') || contains(join(github.event.issue.labels.*.name, ','), 'claude-code')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 本文解析（全角コロン/スペース許容、CRLF正規化）
      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const bodyRaw = context.payload.issue?.body ?? "";
            // 改行/不可視文字の正規化
            const body = bodyRaw.replace(/\r\n/g, "\n").replace(/\u00A0/g, " "); // NBSP → space

            // FILE_PATH: または FILE_PATH： を許容（先頭/前スペース許容）
            const mPath = body.match(/^\s*FILE_PATH[:：]\s*(.+)\s*$/m);
            const file_path = mPath?.[1]?.trim() ?? "";

            // COMMIT_MSG: または COMMIT_MSG： を許容
            const mMsg = body.match(/^\s*COMMIT_MSG[:：]\s*(.+)\s*$/m);
            const commit_msg = (mMsg?.[1]?.trim() || "Claude auto-implementation");

            // ```python ... ``` 優先、なければ最初の ``` ... ```
            let code = "";
            const pyBlock = body.match(/```python\s*([\s\S]*?)```/i);
            if (pyBlock) {
              code = pyBlock[1];
            } else {
              const anyBlock = body.match(/```+\s*([\s\S]*?)```+/);
              if (anyBlock) code = anyBlock[1];
            }
            // 先頭BOM除去
            code = code.replace(/^\uFEFF/, "");

            const ready = Boolean(file_path && code);

            core.startGroup("Parsed inputs");
            core.info(`title=${context.payload.issue?.title}`);
            core.info(`file_path="${file_path}"`);
            core.info(`commit_msg="${commit_msg}"`);
            core.info(`code_length=${code.length}`);
            core.endGroup();

            core.setOutput("ready", String(ready));
            core.setOutput("file_path", file_path);
            core.setOutput("commit_msg", commit_msg);
            core.setOutput("code_b64", Buffer.from(code, "utf8").toString("base64"));

            if (!ready) {
              core.notice("Required fields missing. Need [CLAUDE-CODE] title/label, FILE_PATH line, and a fenced code block (```python ... ```).");
            }

      # 追加のデバッグ出力（UIで一目で分かる）
      - name: Debug outputs
        run: |
          echo "ready=${{ steps.parse.outputs.ready }}"
          echo "file_path=${{ steps.parse.outputs.file_path }}"
          echo "commit_msg=${{ steps.parse.outputs.commit_msg }}"
          echo "code_b64 length=$(echo "${{ steps.parse.outputs.code_b64 }}" | wc -c)"

      # 不足時は成功で静かに終了（メールの失敗通知を出さない）
      - name: Stop when not ready
        if: steps.parse.outputs.ready != 'true'
        run: |
          echo "Not ready -> stop successfully."
          exit 0

      - name: Write file from code
        run: |
          FILE_PATH="${{ steps.parse.outputs.file_path }}"
          mkdir -p "$(dirname "$FILE_PATH")"
          echo "${{ steps.parse.outputs.code_b64 }}" | base64 -d > "$FILE_PATH"
          echo "Wrote $FILE_PATH"
          head -5 "$FILE_PATH" || true

      - name: Python syntax check (optional)
        run: |
          FILE_PATH="${{ steps.parse.outputs.file_path }}"
          [[ "$FILE_PATH" == *.py ]] && python3 -m py_compile "$FILE_PATH" && echo "Syntax OK" || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          title: "Claude Auto: ${{ steps.parse.outputs.file_path }}"
          body: |
            Auto-generated by Claude
            File: `${{ steps.parse.outputs.file_path }}`
            Issue: #${{ github.event.issue.number }}
          branch: claude-auto-${{ github.event.issue.number }}
          commit-message: "${{ steps.parse.outputs.commit_msg }}"

      - name: Comment success
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "Claude automation: PR created successfully! ✅"
            });
